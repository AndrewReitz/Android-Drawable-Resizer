/**

JSZip - A Javascript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2011 David Duponchel <d.duponchel@gmail.com>
Dual licenced under the MIT license or GPLv3. See LICENSE.markdown.

**/

(function(){function i(e){this.stream="";if(JSZip.support.uint8array&&e instanceof Uint8Array)this.stream=JSZip.utils.uint8Array2String(e);else if(JSZip.support.arraybuffer&&e instanceof ArrayBuffer){var t=new Uint8Array(e);this.stream=JSZip.utils.uint8Array2String(t)}else this.stream=JSZip.utils.string2binary(e);this.index=0}function s(e,t){this.options=e,this.loadOptions=t}function o(e,t){this.files=[],this.loadOptions=t,e&&this.load(e)}var e=65535,t=-1,n=function(e){var t="",n,r;for(r=0;r<(e||"").length;r++)n=e.charCodeAt(r),t+="\\x"+(n<16?"0":"")+n.toString(16).toUpperCase();return t},r=function(e){for(var t in JSZip.compressions){if(!JSZip.compressions.hasOwnProperty(t))continue;if(JSZip.compressions[t].magic===e)return JSZip.compressions[t]}return null};i.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.stream.length<e||e<0)throw new Error("End of stream reached (stream length = "+this.stream.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(e){return this.stream.charCodeAt(e)},readInt:function(e){var t=0,n;this.checkOffset(e);for(n=this.index+e-1;n>=this.index;n--)t=(t<<8)+this.byteAt(n);return this.index+=e,t},readString:function(e){this.checkOffset(e);var t=this.stream.slice(this.index,this.index+e);return this.index+=e,t},readDate:function(){var e=this.readInt(4);return new Date((e>>25&127)+1980,(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(e&31)<<1)}},s.prototype={isEncrypted:function(){return(this.bitFlag&1)===1},useUTF8:function(){return(this.bitFlag&2048)===2048},readLocalPart:function(e){var t,i;e.skip(22),this.fileNameLength=e.readInt(2),i=e.readInt(2),this.fileName=e.readString(this.fileNameLength),e.skip(i);if(this.compressedSize==-1||this.uncompressedSize==-1)throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize == -1 || uncompressedSize == -1)");this.compressedFileData=e.readString(this.compressedSize),t=r(this.compressionMethod);if(t===null)throw new Error("Corrupted zip : compression "+n(this.compressionMethod)+" unknown (inner file : "+this.fileName+")");this.uncompressedFileData=t.uncompress(this.compressedFileData);if(this.uncompressedFileData.length!==this.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch");if(this.loadOptions.checkCRC32&&JSZip.prototype.crc32(this.uncompressedFileData)!==this.crc32)throw new Error("Corrupted zip : CRC32 mismatch")},readCentralPart:function(e){this.versionMadeBy=e.readString(2),this.versionNeeded=e.readInt(2),this.bitFlag=e.readInt(2),this.compressionMethod=e.readString(2),this.date=e.readDate(),this.crc32=e.readInt(4),this.compressedSize=e.readInt(4),this.uncompressedSize=e.readInt(4),this.fileNameLength=e.readInt(2),this.extraFieldsLength=e.readInt(2),this.fileCommentLength=e.readInt(2),this.diskNumberStart=e.readInt(2),this.internalFileAttributes=e.readInt(2),this.externalFileAttributes=e.readInt(4),this.localHeaderOffset=e.readInt(4);if(this.isEncrypted())throw new Error("Encrypted zip are not supported");this.fileName=e.readString(this.fileNameLength),this.readExtraFields(e),this.parseZIP64ExtraField(e),this.fileComment=e.readString(this.fileCommentLength),this.dir=this.externalFileAttributes&16?!0:!1},parseZIP64ExtraField:function(e){if(!this.extraFields[1])return;var n=new i(this.extraFields[1].value);this.uncompressedSize===t&&(this.uncompressedSize=n.readInt(8)),this.compressedSize===t&&(this.compressedSize=n.readInt(8)),this.localHeaderOffset===t&&(this.localHeaderOffset=n.readInt(8)),this.diskNumberStart===t&&(this.diskNumberStart=n.readInt(4))},readExtraFields:function(e){var t=e.index,n,r,i;this.extraFields=this.extraFields||{};while(e.index<t+this.extraFieldsLength)n=e.readInt(2),r=e.readInt(2),i=e.readString(r),this.extraFields[n]={id:n,length:r,value:i}},handleUTF8:function(){this.useUTF8()&&(this.fileName=JSZip.prototype.utf8decode(this.fileName),this.fileComment=JSZip.prototype.utf8decode(this.fileComment))}},o.prototype={checkSignature:function(e){var t=this.reader.readString(4);if(t!==e)throw new Error("Corrupted zip or bug : unexpected signature ("+n(t)+", expected "+n(e)+")")},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2),this.zipComment=this.reader.readString(this.zipCommentLength)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.versionMadeBy=this.reader.readString(2),this.versionNeeded=this.reader.readInt(2),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};var e=this.zip64EndOfCentralSize-44,t=0,n,r,i;while(t<e)n=this.reader.readInt(2),r=this.reader.readInt(4),i=this.reader.readString(r),this.zip64ExtensibleData[n]={id:n,length:r,value:i}},readBlockZip64EndOfCentralLocator:function(){this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4);if(this.disksCount>1)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var e,t;for(e=0;e<this.files.length;e++)t=this.files[e],this.reader.setIndex(t.localHeaderOffset),this.checkSignature(JSZip.signature.LOCAL_FILE_HEADER),t.readLocalPart(this.reader),t.handleUTF8()},readCentralDir:function(){var e;this.reader.setIndex(this.centralDirOffset);while(this.reader.readString(4)===JSZip.signature.CENTRAL_FILE_HEADER)e=new s({zip64:this.zip64},this.loadOptions),e.readCentralPart(this.reader),this.files.push(e)},readEndOfCentral:function(){var n=this.reader.stream.lastIndexOf(JSZip.signature.CENTRAL_DIRECTORY_END);if(n===-1)throw new Error("Corrupted zip : can't find end of central directory");this.reader.setIndex(n),this.checkSignature(JSZip.signature.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral();if(this.diskNumber===e||this.diskWithCentralDirStart===e||this.centralDirRecordsOnThisDisk===e||this.centralDirRecords===e||this.centralDirSize===t||this.centralDirOffset===t){this.zip64=!0,n=this.reader.stream.lastIndexOf(JSZip.signature.ZIP64_CENTRAL_DIRECTORY_LOCATOR);if(n===-1)throw new Error("Corrupted zip : can't find the ZIP64 end of central directory locator");this.reader.setIndex(n),this.checkSignature(JSZip.signature.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(JSZip.signature.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}},load:function(e){this.reader=new i(e),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},JSZip.prototype.load=function(e,t){var n,r,i,s;t=t||{},t.base64&&(e=JSZipBase64.decode(e)),r=new o(e,t),n=r.files;for(i=0;i<n.length;i++)s=n[i],this.file(s.fileName,s.uncompressedFileData,{binary:!0,optimizedBinaryString:!0,date:s.date,dir:s.dir});return this}})();